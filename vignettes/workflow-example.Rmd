---
title: "workflow-example"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{workflow-example}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

This workflow should show full strength of *RRatepol package* and serve as step by 
step guidance starting from downloading dataset from Neotoma, building age-depth
models, to estimating rate-of-chage using age uncertainty.

## import packages

```{r setup, results = FALSE, warning = FALSE}
library(tidyverse)
library(RRatepol)
library(neotoma)
library(Bchron)
library(janitor)
```

## Download the dataset *Glendalough Valley* from Neotoma

```{r download of data, results = FALSE, warning = FALSE}
gl_dataset_download <- neotoma::get_download(17334)

chronology_id <- 
  gl_dataset_download[[1]]$sample.meta$chronology.id %>% 
  unique()

gl_chron_control_table_download <- neotoma::get_chroncontrol(chronology_id)

```

## Prepare the pollen counts
```{r count preparation, results = FALSE, warning = FALSE}
gl_counts <- 
  gl_dataset_download[[1]]$counts 

gl_taxon_lits <- 
  gl_dataset_download[[1]]$taxon.list

gl_taxon_lits_selected <- 
gl_taxon_lits %>% 
  dplyr::filter(variable.element == "pollen")

gl_counts_selected <-
  gl_counts %>% 
  as.data.frame() %>% 
  tibble::rownames_to_column(., var = "sample.id") %>% 
  as_tibble() %>% 
  dplyr::select(sample.id, dplyr::any_of(gl_taxon_lits_selected$taxon.name)) %>% 
  janitor::clean_names() %>% 
  rename(sample.id = sample_id)

```

Here, we strongly advocate that attention should be paid to the section of 
ecological ecological group, as well, as harmonisation of the pollen taxa.
However, that is not subject of this workflow.

## Preparation of the levels

### Sample depth

Extract depth for each level

```{r level preparion, results = FALSE, warning = FALSE}
gl_level <-
  gl_dataset_download[[1]]$sample.meta %>% 
  as_tibble() %>% 
  dplyr::select(sample.id, depth) %>% 
  dplyr::mutate_if(is.integer, as.character)

```

### Age depth modelling

We will recalculate new age-depth model 'de novo' using *Bchon* package. In this 
toy example we will use only iteration multiplier (*i_multiplier*) of 1. 
We stronly recommend to increase it to 5. 

Prepare chron.control table and run Bchron

```{r Bchron, results = FALSE, warning = FALSE}
i_multiplier <- 1

n_iteration_default <- 10e3
n_burn_default <- 2e3
n_thin_default <- 8

n_iteration <- n_iteration_default * i_multiplier
n_burn <- n_burn_default * i_multiplier
n_thin <- n_thin_default * i_multiplier

gl_chron_control_table <-
  gl_chron_control_table_download$chron.control %>% 
  dplyr::mutate(
    error = round((age.old - age.young) / 2)) %>% 
  dplyr::mutate(
    error = replace(error, error == 0, 1)) %>% 
  dplyr::mutate(
    curve = ifelse(control.type == "Radiocarbon", "intcal20", "normal"))

gl_bchron <- 
  Bchron::Bchronology(
    ages = gl_chron_control_table$age,
    ageSds = gl_chron_control_table$error,
    positions = gl_chron_control_table$depth,
    calCurves = gl_chron_control_table$curve,
    positionThicknesses = gl_chron_control_table$thickness,
    iterations = n_iteration,
    burn = n_burn,
    thin = n_thin,
    jitterPositions = TRUE)

```

Predict ages

```{r Predic ages, results = FALSE, warning = FALSE}
age_position <- 
  Bchron:::predict.BchronologyRun(gl_bchron, newPositions = gl_level$depth)
  
age_uncertainties <- 
  age_position %>% 
  as.data.frame() %>% 
  dplyr::mutate_all(., as.integer) %>% 
  as.matrix()
  
colnames(age_uncertainties) <- gl_level$sample.id

gl_level_predicted <- 
  gl_level %>% 
  dplyr::mutate(
    age = apply(
    age_uncertainties, 2,
    stats::quantile,
    probs = 0.5)
  )

```

## Estimation Rate-of-Change

Here we use the the prepared data to estimate the rate of vegetation change. We
will use the method of the *binning with the mowing window*, *Shepard's 5-term filter* 
as data smoothing *Chi-squared coefficient* as dissimilarity coefficient.
This is again a toy example and we would recommend increasing the *r_multiplier* 
to 10. 

```{r RoC, results = FALSE, warning = FALSE}

r_multiplier <- 1

randomisations_default <- 1e3

randomisations <- randomisations_default * r_multiplier

gl_roc <-
    RRatepol::fc_estimate_RoC(
      data_source_community = gl_counts_selected,
      data_source_age = gl_level_predicted,
      age_uncertainty = age_uncertainties,
      smooth_method = "shep",
      DC = "chisq",
      Working_Units = "MW",
      bin_size = 500,
      Number_of_shifts  = 5,
      standardise = T,
      N_individuals = 150,
      rand = randomisations,
      treads = T)

```

Detect peak-points and plot the results

```{r Peak points, results = FALSE, warning = FALSE}
gl_roc_peaks <-
  RRatepol::fc_detect_peak_points(gl_roc, method = "trend_non_linear")
```


```{r Figure, results = TRUE, echo = TRUE}
RRatepol::fc_plot_RoC_sequence(
  gl_roc_peaks, age_treshold= 8e3, Roc_threshold = 1.5, Peaks = TRUE, trend = "trend_non_linear")
```

